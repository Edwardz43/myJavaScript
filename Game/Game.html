<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<title>Game</title>    
<head>
<script type="text/javascript" src="jquery.js"></script>
<style>
#myCanvas{
    position: absolute;
    top: 0;
    left: 0;
    width : 1280px; 
    height : 600px;
}
#myBG {
	position: relative;
	width: 1280px;
	height: 600px;
	margin: 0;
	overflow: hidden;
	outline: 1px solid gray;
}

#bGImg {
	position: relative;
	width: 3502px;
	height: 600px;
	background : url('images/BG003.jpg');
	background-repeat: repeat-x;
    animation: rollImage linear 50s infinite;
    z-index:-1;
}


@keyframes rollImage {
	from { right: 0px; }
	to { right: 2062px; }
}

</style>
<body>
<img id="fireBall" src="images/fire01.png" style="display: none"></img>
<div id="myBG">
    <div id="bGImg"></div>
</div>
<div><canvas class="myGame" id="myCanvas"></canvas></div>
<br>
<div id="report"></div>

</body>
<script>

    $(document).ready(function(){
        var canvas = $('#myCanvas')[0];
        var ctx = canvas.getContext('2d');
        var gameLoop;
        var balls = [];
        var dImg = new Image();
        var eImg = new Image();
        var vImag = new Image();
        var enermys = [];
        
        var dragon = {
            level : 1,
            exp : 0,
            lupExp : 100,
            maxHp : 200,
            hp : 200,
            X : 100,
            Y : 100,
            dx : 0,
            dy : 0,
            speed : 2,
            width : 35,
            height : 30,
            Move : "none",
            beHit : false,
            shot : function (){
                balls.push(new Ball(dragon.X + 25, dragon.Y + 15 -dragon.level, 3));
                var fireSound = new Audio('BGM/wing1.mp3');
                fireSound.volume = 0.3;
                fireSound.play();
            }
        }
        
        function moveDragon(){
            if(dragon.hp > 0){
                switch(dragon.Move) {
                    case 'LEFT':
                        dragon.dx = -dragon.speed;
                        break;
                    case 'UP':
                        dragon.dy = -dragon.speed;
                        break;    
                    case 'RIGHT':
                        dragon.dx = dragon.speed;
                        break;
                    case 'DOWN':
                        dragon.dy = dragon.speed;
                        break;    
                    case 'l-NONE':
                    case 'r-NONE':
                        dragon.dx = 0;
                        break;
                    case 'u-NONE':
                    case 'd-NONE':
                        dragon.dy = 0;
                        break;
                }
                //bug
                if (dragon.X + dragon.dx < 0 || dragon.X + dragon.dx + dragon.width >= canvas.width){
                    dragon.dx = 0; 
                }
                if (dragon.Y + dragon.dy < 0 || dragon.Y + dragon.dy +dragon.height > canvas.height){
                    dragon.dy = 0; 
                }
                dragon.X = dragon.X + dragon.dx;
                dragon.Y = dragon.Y + dragon.dy;
            }
        }
        
        var drawCount = 1;
        var hitCount = 0;
        function drawDragon(){
            if(!dragon.beHit){
                if (drawCount >= 24) drawCount = 1;
                ctx.save();
                dImg.src = 'images/dR0' + Math.floor(drawCount / 6 + 1) + '.png',
                ctx.drawImage(dImg, dragon.X, dragon.Y, dragon.width , dragon.height );
                ctx.restore();   
                drawCount++;
            }else{
                if(drawCount >= 24)drawCount = 1;
                if (drawCount % 4 == 0 && hitCount <= 50) {
                    ctx.save();
                    dImg.src = 'images/dR0' + Math.floor(drawCount / 6 + 1) + '.png',
                    ctx.drawImage(dImg, dragon.X, dragon.Y, dragon.width , dragon.height );
                    ctx.restore();
                }else if(hitCount > 50){
                    dragon.beHit = false;
                    hitCount =0;
                }
                hitCount++
                drawCount++;
            }
        }
        
        
        var enermy = function () {
            this.level = 1;
            this.hp = 20;
            this.X = 320;
            this.Y = 90 + Math.random()* 20;
            this.dx = -0.5;
            this.dy = 0;
            this.width = 40;
            this.height = 40;
            this.exp = 10;
            this.power = 10;
            
            
            this.shot = function (){
                if(this.hp > 0){
                    balls.push(new Ball(this.X - 25, this.Y + 15 -this.level, -3));
                    var fireSound = new Audio('BGM/wing1.mp3');
                    fireSound.volume = 0.3;
                    fireSound.play();
                }
            }
            
            this.moveEnermy = function (){
                if(this.hp > 0){
                    //判斷是否撞到
                    if(!dragon.beHit){
                        if(this.X - this.width*0.7 <= dragon.X  &&
                            this.X + this.width*0.7 >= dragon.X  &&
                            this.Y - this.height*0.7 <= dragon.Y  &&
                            this.Y + this.height*0.7 >= dragon.Y){
                                reduceHp(this.power);
                                dragon.beHit = true;
                        }
                    }
                    
                    if(this.Y + this.height >= canvas.height ||
                        this.Y - this.height <= 0 ) {this.dy *= -1;}
                    this.X += this.dx;
                    this.Y += this.dy;
                    
                     //走出銀幕就刪掉怪物
                    if(this.X  <= 0 ) {
                            enermys.splice(enermys.indexOf(this), 1);
                    }
                }
            }
            var cLive = 1;
            var cDead = 1;
            this.drawEnermy = function() {
                if(this.hp > 0){
                    if(cLive >= 40) cLive = 1;
                    eImg.src = 'images/shadow0'+ Math.floor(cLive / 10 + 1) +'.png';
                    ctx.drawImage(eImg, this.X, this.Y, this.width, this.height);
                    cLive++;
                }else{
                    if (cDead < 23){
                        vImag.src = 'images/boom'+ Math.floor(cDead / 4 + 1) +'.png';
                        ctx.drawImage(vImag, this.X, this.Y, this.width, this.height);
                        cDead++;    
                    }else{
                        dragon.exp += this.exp;
                        enermys.splice(enermys.indexOf(this),1);
                        cDead = 1; 
                    }
                    
                }
            }
        }
        
        
        
        function Ball(X, Y, deltaX){
            this.X = X;
            this.Y = Y;
            this.width = 18 + dragon.level;   
            this.height = 9 + dragon.level;
            this.deltaX = deltaX;
            this.power = dragon.level * 5;
            this.hit = false;
        }
            
        function moveBall(ball){
                //攻擊命中
                for(var i=0; i < enermys.length; i++){
                    if (enermys[i].hp > 0) {
                        if ((ball.X + ball.deltaX -ball.width - 10 >= enermys[i].X - enermys[i].width && 
                            ball.X - ball.deltaX  <= enermys[i].X + enermys[i].width &&
                            ball.Y  >= enermys[i].Y && 
                            ball.Y  <= enermys[i].Y + enermys[i].height )){
                            var hitSound = new Audio('BGM/fireworks2.mp3');
                            hitSound.volume = 1;
                            hitSound.play();
                            ball.hit = true;
                            enermys[i].hp -= ball.power;
                        }
                    }
                }
                
                //火球飛超過銀幕 就從陣列中移除火球
                if (ball.X + ball.deltaX + ball.width > canvas.width){
                    //alert("ok");
                    balls.splice(balls.indexOf(ball), 1);
                }
                
                ball.X += ball.deltaX;
            
        }
        
        function drawBall(ball) {
            //如果球被刪除了  就=null 那就不必畫了
            if(ball != null){
                if(ball.hit != true){
                	ctx.save();
                	var fire = document.getElementById('fireBall');
                    ctx.drawImage(fire, ball.X, ball.Y, ball.width, ball.height);
                    ctx.restore();
                }else{
                    
                    balls.splice(balls.indexOf(ball), 1);
                }
            }
        }
        
        var icon = new Image();
        icon.src = 'images/dR01.png';
        
        function drawState(){
            ctx.save();
            var hpLength = (dragon.hp <= 0)?0:(dragon.hp / dragon.maxHp) * 100;
            var expBar = (dragon.exp / dragon.lupExp) * 98
            //dragon icon
            ctx.drawImage(icon, 3, 3, 21, 15);
            
            //dragon HP
            ctx.fillStyle="#842B00";
            ctx.strokeRect(24,7,102,12);
            ctx.fillStyle="#EA0000";
            ctx.fillRect(25,8, 100, 10);
            ctx.fillStyle="#FFD306";
            ctx.fillRect(25,8, hpLength, 10);
            
            //dragon EXP
            ctx.fillStyle="#842B00";
            ctx.strokeRect(25,20,100,3);
            ctx.fillStyle="#28FF28";
            ctx.fillRect(26,21, expBar, 2);
            ctx.restore();
        }
        
        function animate(){
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            moveDragon();
            drawDragon();
            if(dragon.exp >= dragon.level*100){
                dragon.level++;
                dragon.lupExp += dragon.level * 100; 
                dragon.maxHp += dragon.level * 50;
                recoverHp();
                dragon.exp = 0;
            }
            
            // if(enermys.length <= 0) enermys.push(new enermy());
            for(var i = 0; i < enermys.length; i++){
                enermys[i].moveEnermy();
                if(enermys[i] != null){
                    enermys[i].drawEnermy();
                }
            }
            for(var i=0; i<balls.length; i++){
                moveBall(balls[i]);  
                drawBall(balls[i]);
            }
            drawState();
            
            var s = "X :" + dragon.X + ", Y :"+dragon.Y + 
            ", c.width :" + canvas.width+ ", c.height :" + canvas.height +
            ", level : " + dragon.level +", HP :"+ dragon.hp + ", beHit :" + dragon.beHit;
            $("#report").text(s);
        }
        
        function reduceHp(x){
            var hpMinus = x; 
            var timer = setInterval(function(){
                dragon.hp--;
                hpMinus--;
                if(hpMinus == 0){
                    clearInterval(timer);
                }
            },50);
        }
        
        function recoverHp(){
            var timer = setInterval(function(){
                dragon.hp++;
                if(dragon.hp == dragon.maxHp){
                    clearInterval(timer);
                }
            },5);
        }
        
        
        function startGame(){

            gameLoop = setInterval(animate, 20);
            
            $(document).keydown(function(evt) {
                switch (evt.keyCode) {
                    case 13:
                        enermys.push(new enermy());
                        break;
                    case 32:
                        dragon.shot();
                        break;
                    case 37:
                        dragon.Move = 'LEFT';
                        break;
                    case 38:
                        dragon.Move = 'UP';
                        break;
                    case 39:
                        dragon.Move = 'RIGHT';
                        break;
                    case 40:
                        dragon.Move = 'DOWN';
                        break;
                    
                    default:
                        dragon.Move = 'NONE';
                }
            });         
            
            $(document).keyup(function(evt) {
                switch (evt.keyCode) {
                    case 37:
                        dragon.Move = 'l-NONE';
                        break;
                    case 38:
                        dragon.Move = 'u-NONE';
                        break;
                    case 39:
                        dragon.Move = 'r-NONE';
                        break;
                    case 40:
                        dragon.Move = 'd-NONE';
                        break;
                    default:
                        dragon.Move = 'NONE';
                }
            }); 
        }

        startGame();

    });
</script>
</head>
</html>