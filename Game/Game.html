<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Game</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="jquery.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

</head>
<style>

</style>
<body>
        
<div id="report"></div>
<!--<div id="report2">11</div>-->
<div class="myGame" ><canvas  id="myCanvas"></canvas></div>
<div id="myBG">
    <div id="bGImg"></div>
</div>
<br>

<!--modal test-->
<div class="container">
  <h2>Pause</h2>
   <!--Trigger the modal with a button -->
  <button type="button" class="btn btn-info btn-lg" id="myBtn">Press</button>

  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">暫停!</h4>
        </div>
        <div class="modal-body">
          <p>休息一下...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
      
    </div>
  </div>
  
</div>

</body>

<script>

    $(document).ready(function(){
        
        //暫停
        $("#myBtn").click(function(){
            $("#myModal").modal();
            isGaming = false;
            $('.btn-default').click(function(){
                isGaming = true;
            });
        });
        
        var isGaming = true;
        var canvas = $('#myCanvas')[0];
        var ctx = canvas.getContext('2d');
        var gameLoop;
        var balls = [];
        var enermyballs = [];
        var dImg = new Image();
        var eImg = new Image();
        var e2Img = new Image();
        var vImg = new Image();
        var v2Img = new Image();
        var cImg = new Image();
        var chargeNum = 1;
        var isCharging = false;
        var chargeSound = new Audio('BGM/charge.wav');
        chargeSound.volume = 0.2;
        chargeSound.loop = true;
        var fbCount = 0;
        var enermys = [];
        
        var dragon = {
            level : 1,
            exp : 0,
            lupExp : 100,
            maxHp : 120,
            hp : 120,
            X : 100,
            Y : 100,
            dx : 0,
            dy : 0,
            speed : 1.5,
            width : 25,
            height : 21,
            Move : "none",
            beHit : false,
            shot : function (){
                var power = chargeNum > 50 ? chargeNum/50 : 1;
    
            	if(power > 1){
            	    balls.push(new Ball(dragon.X - 5, dragon.Y , power, 3 , -0.5));
            	    balls.push(new Ball(dragon.X - 5, dragon.Y + 8, power, 3, 0.5));
            	}
            	
            // 	if(power >3) {
        	   //     balls.push(new Ball(dragon.X + 15, dragon.Y, power,3 , -1));
            // 	    balls.push(new Ball(dragon.X + 15, dragon.Y + 8, power, 3, 1));    
            // 	}
                balls.push(new Ball(dragon.X - 5, dragon.Y + 4, power,3 ,0));
                var fireSound = new Audio('BGM/fire.ogg');
                fireSound.volume = 0.3;
                fireSound.play();
            }
        }
        
        function charge (){
            var timer = setInterval(function(){
                chargeNum++;
                
                if(chargeNum >= 200) {
                    chargeNum = 200;
                }
                
                $(document).keyup(function(evt) { 
                    if(evt.keyCode == 32) {
                        isCharging = false;
                        chargeNum = 1;
                        chargeSound.pause();
                        chargeSound.load();
                        clearInterval(timer);
                    } 
                });
                
            }, 20);
        }
        
        function moveDragon(){
            if(dragon.hp > 0){
                
                if(dragon.Move == 'LEFT'){
                    dragon.dx = -dragon.speed;    
                }
                if( dragon.Move =='RIGHT'){
                    dragon.dx = dragon.speed; 
                }
                if(dragon.Move == 'UP'){
                    dragon.dy = -dragon.speed;    
                }
                if(dragon.Move =='DOWN'){
                    dragon.dy = dragon.speed; 
                }
                if(dragon.Move == 'l-NONE' || dragon.Move == 'r-NONE'){
                    dragon.dx = 0;    
                }
                if(dragon.Move == 'u-NONE' || dragon.Move == 'd-NONE'){
                    dragon.dy = 0;    
                }
                
                if (dragon.X + dragon.dx < 0 || dragon.X + dragon.dx + dragon.width >= canvas.width){
                    dragon.dx = 0; 
                }
                if (dragon.Y + dragon.dy < 0 || dragon.Y + dragon.dy +dragon.height > canvas.height){
                    dragon.dy = 0; 
                }
                dragon.X = dragon.X + dragon.dx;
                dragon.Y = dragon.Y + dragon.dy;
            }
        }
        
        var drawCount = 0;
        var hitCount = 0;
        var chargeCount = 0;
        var deadCount = 0;
        function drawDragon(){
            if(dragon.hp >0){
                if(!dragon.beHit){
                    if (drawCount >= 18) drawCount = 0;
                    ctx.save();
                    dImg.src = 'images/fairy02.png',
                    ctx.drawImage(dImg, Math.floor(drawCount / 6)*50 ,84 , 50, 42, dragon.X, dragon.Y, dragon.width , dragon.height);
                    //alert(dImg.src);
                    ctx.restore();   
                    drawCount++;
                
                }else{
                    if(drawCount >= 18)drawCount = 0;
                    if (drawCount % 4 == 0 && hitCount <= 50) {
                        ctx.save();
                        dImg.src = 'images/fairy02.png',
                        //ctx.drawImage(dImg, dragon.X, dragon.Y, dragon.width , dragon.height );
                        ctx.drawImage(dImg, Math.floor(drawCount / 6)*50 , 84, 50, 42, dragon.X, dragon.Y, dragon.width , dragon.height);
                        ctx.restore();
                    }else if(hitCount > 50){
                        dragon.beHit = false;
                        hitCount =0;
                    }
                    hitCount++
                    drawCount++;
                }
                if(isCharging){
                    if(chargeCount >= 60)chargeCount = 0;
                    ctx.save();
                    cImg.src = 'images/charging.png',
                    ctx.drawImage(cImg, Math.floor(chargeCount / 6)*240 , 0, 240, 240, dragon.X - 2, dragon.Y - 7, 40 , 40);
                    chargeCount++
                    ctx.restore();
                }
            }else{
                if(deadCount < 121){
                    ctx.save();
                    dImg.src = 'images/deadeffect.png',
                    ctx.drawImage(dImg, 0, Math.floor(deadCount / 15)*240, 640, 240, dragon.X - 150, dragon.Y - 50, 64*5 , 24*5);
                    deadCount++
                    ctx.restore();    
                }
            }
            
        }
        
        //火球 
        function Ball(X, Y, power,dx, dy){
            this.X = X;
            this.Y = Y;
            this.width = 32, 
            // + dragon.level;   
            this.height = 24,
            // + dragon.level;
            this.deltaX = dx,
            this.deltaY = dy;
            this.power = dragon.level * 10 * power;
            this.hit = false;
        }
            
        function moveBall(ball){
            //攻擊命中
            for(var i=0; i < enermys.length; i++){
                var midX = enermys[i].X + enermys[i].width / 2;    
                var midY = enermys[i].Y + enermys[i].height / 2;
            
                if (enermys[i].hp > 0) {
                    if ((
                        ball.X + ball.deltaX + ball.width >= midX  && 
                        ball.X - ball.deltaX  <= midX + enermys[i].width /2 &&
                        ball.Y + ball.height * 0.5 >= midY - enermys[i].height * 0.5 && 
                        ball.Y - ball.height * 0.5 <= midY + enermys[i].height * 0.5
                        )){
                        var hitSound = new Audio('BGM/enermy.wav');
                        hitSound.volume = 0.5;
                        hitSound.play();
        
                        if(ball.power / dragon.level <= 20) ball.hit = true;
                        else ball.power -= 8;
                        
                        enermys[i].hp -= ball.power;
                        if(enermys[i].hp <= 0) {
                            var enermyDown = new Audio('BGM/enermydown01.wav');
                            enermyDown.volume = 0.5;
                            enermyDown.play();
                        }
                        
                        if(ball.power ==0 )balls.splice(balls.indexOf(ball), 1);
                    }
                }
            }
            //火球飛超過銀幕 就從陣列中移除火球
            if (ball.X + ball.deltaX  > canvas.width ){
                //alert("ok");
                balls.splice(balls.indexOf(ball), 1);
            }
            
            ball.X += ball.deltaX;
            ball.Y += ball.deltaY;
        }
        
        function drawBall(ball) {
            //如果球被刪除了  就=null 那就不必畫了
            if(ball != null){
                if(ball.hit != true){
                	ctx.save();
                	var dBall = new Image();
                	dBall.src = 'images/chargeball.png'
                    ctx.drawImage(
                        dBall, (fbCount %3)*320 , Math.floor(fbCount/3)*240, 320, 240,
                        ball.X + 5, ball.Y, ball.width, ball.height
                        );
                    ctx.restore();
                    fbCount++;
                    if(fbCount >= 30) fbCount = 1;
                    
                }else {
                    balls.splice(balls.indexOf(ball), 1);
                }
            }
        }
        
        //敵人
        var enermy = function () {
            this.level = dragon.level;
            this.hp = 50 + this.level*20;
            this.X = 300;
            this.Y = 110 + Math.random()* 10;
            this.dx = -(0.3 + Math.random()* 0.2);
            this.dy = 0;
            this.width = 25;
            this.height = 25;
            this.exp = 10 + this.level * 10;
            this.power = 10* this.level;
            
            
            this.shot = function (){
                if(this.hp > 0){
                    var deltaX = 3* Math.sin(Math.atan2(this.X - dragon.X, this.Y - dragon.Y));
                    var deltaY = 3* Math.cos(Math.atan2(this.X - dragon.X, this.Y - dragon.Y));
                    enermyballs.push(new EnermyBall(this.X + 5, this.Y + 10, -deltaX, -deltaY, this.level));
                }
            }
            
            this.moveEnermy = function (){
                if(this.hp > 0){
                    //判斷是否撞到
                    if(!dragon.beHit){
                        if(this.X - this.width*0.7 <= dragon.X  &&
                            this.X + this.width*0.7 >= dragon.X  &&
                            this.Y - this.height*0.7 <= dragon.Y  &&
                            this.Y + this.height*0.7 >= dragon.Y){
                                reduceHp(this.power);
                                dragon.beHit = true;
                        }
                    }
                    
                    if(this.Y + this.height >= canvas.height ||
                        this.Y - this.height <= 0 ) {this.dy *= -1;}
                    this.X += this.dx;
                    this.Y += this.dy;
                    
                     //走出銀幕就刪掉怪物
                    if(this.X  <= 0 ) {
                        enermys.splice(enermys.indexOf(this), 1);
                    }
                }
            }
            
            var liveCount = 0;
            var deadCount = 0;
            this.drawEnermy = function() {
                if(this.hp > 0){
                    if(liveCount >= 18) liveCount = 0;
                    eImg.src = 'images/shadow.png';
                    ctx.drawImage(
                        eImg, 
                        Math.floor(liveCount / 6)*60, 60, 60, 60, 
                        this.X, this.Y, this.width, this.height
                        );
                    liveCount++;
                }else{
                    if (deadCount < 41){
                        vImg.src = 'images/boom.png';
                        ctx.drawImage(vImg, Math.floor(deadCount / 5)* 240, 0, 240, 240, this.X, this.Y, this.width, this.height);
                        deadCount++;    
                    }else{
                        dragon.exp += this.exp;
                        enermys.splice(enermys.indexOf(this),1);
                        deadCount = 0; 
                    }
                }
            }
        }
        
        var enermy2 = function () {
            this.level = dragon.level;
            this.hp = 40 + this.level*20;
            this.X = 300;
            this.Y = 50 + Math.random()* 20;
            this.dx = -(0.5 + Math.random()* 0.5);
            this.dy = 0;
            this.width = 25;
            this.height = 25;
            this.exp = 10 + this.level * 10;
            this.power = 12* this.level;
            
            
            this.shot = function (){
                if(this.hp > 0){
                    var deltaX = 3* Math.sin(Math.atan2(this.X - dragon.X, this.Y - dragon.Y));
                    var deltaY = 3* Math.cos(Math.atan2(this.X - dragon.X, this.Y - dragon.Y));
                    enermyballs.push(new EnermyBall(this.X + 5, this.Y + 10, -deltaX, -deltaY, this.level));
                }
            }
            
            this.moveEnermy = function (){
                if(this.hp > 0){
                    //判斷是否撞到
                    if(!dragon.beHit){
                        if(this.X - this.width*0.7 <= dragon.X  &&
                            this.X + this.width*0.7 >= dragon.X  &&
                            this.Y - this.height*0.7 <= dragon.Y  &&
                            this.Y + this.height*0.7 >= dragon.Y){
                                reduceHp(this.power);
                                dragon.beHit = true;
                        }
                    }
                    
                    if(this.Y + this.height >= canvas.height ||
                        this.Y - this.height <= 0 ) {this.dy *= -1;}
                    this.X += this.dx;
                    this.Y += this.dy;
                    
                     //走出銀幕就刪掉怪物
                    if(this.X  <= 0 ) {
                        enermys.splice(enermys.indexOf(this), 1);
                    }
                }
            }
            
            var liveCount = 0;
            var deadCount = 0;
            this.drawEnermy = function() {
                if(this.hp > 0){
                    if(liveCount >= 18) liveCount = 0;
                    e2Img.src = 'images/grif05b.png';
                    ctx.drawImage(
                        e2Img, 
                        Math.floor(liveCount / 6)*45, 50, 45, 50, 
                        this.X, this.Y, this.width, this.height
                        );
                    liveCount++;
                }else{
                    if (deadCount < 41){
                        vImg.src = 'images/boom.png';
                        ctx.drawImage(vImg, Math.floor(deadCount / 5)* 240, 0, 240, 240, this.X, this.Y, this.width, this.height);
                        deadCount++;    
                    }else{
                        dragon.exp += this.exp;
                        enermys.splice(enermys.indexOf(this),1);
                        deadCount = 0; 
                    }
                }
            }
        }
        
        function EnermyBall(X, Y, deltaX, deltaY,level){
            this.X = X;
            this.Y = Y;
            this.width = 3;   
            this.height = 3;
            this.deltaX = deltaX;
            this.deltaY = deltaY;
            this.power = level * 10;
            this.hit = false;
        }
        
        function moveEnermyBall(ball){
            var midX = dragon.X + dragon.width / 2;
            var midY = dragon.Y + dragon.height / 2;
            //攻擊命中
            if (dragon.hp > 0 && dragon.beHit == false) {
                if ((
                    ball.X + ball.deltaX  >= midX - dragon.width *0.5 && 
                    ball.X - ball.deltaX  <= midX + dragon.width *0.5 &&
                    ball.Y + ball.deltaY  >= midY - dragon.height *0.5 && 
                    ball.Y - ball.deltaY  <= midY + dragon.height *0.5
                    )){
                    var hitSound = new Audio('BGM/hurt02.wav');
                    hitSound.volume = 0.5;
                    hitSound.play();
                    ball.hit = true;
                    dragon.beHit = true;
                    reduceHp(ball.power);
                    //alert(ball.power)
                }
            }
            //火球飛超過銀幕 就從陣列中移除火球
            if (ball.X + ball.deltaX  - ball.width> canvas.width||
                ball.X + ball.deltaX  < 0){
                //alert("ok");
                enermyballs.splice(enermyballs.indexOf(ball), 1);
                return;
            }
            
            ball.X += ball.deltaX;
            ball.Y += ball.deltaY;
        }
        
        function drawEnermyBall(ball) {
            //如果球被刪除了  就=null 那就不必畫了
            if(ball != null){
                if(ball.hit != true){
                	ctx.save();
                    var grd = ctx.createRadialGradient(
                        ball.X, ball.Y, 3 , ball.X - 1, ball.Y - 1, 0);
                    grd.addColorStop(0, "yellow");
                    grd.addColorStop(1, "white");
                    ctx.fillStyle = grd;
                    ctx.beginPath();
                    ctx.arc(ball.X, ball.Y,3, 0, Math.PI * 2, true);
                    ctx.fill();
                    ctx.restore();
                }else{
                    enermyballs.splice(enermyballs.indexOf(ball), 1);
                    return;
                }
            }
        }
        
        
        //畫狀態
        var icon = new Image();
        icon.src = 'images/fairy03.png';
        
        function drawState(){
            ctx.save();
            var hpLength = (dragon.hp <= 0)?0:(dragon.hp / dragon.maxHp) * 100;
            var expBar = (dragon.exp / dragon.lupExp) * 98;
            var chargeBar = (chargeNum/50 / 4) * 28;
            //state
            // var lv = "LV :" + dragon.level;
            // var grd = ctx.createLinearGradient(0,8,10,100);
            // grd.addColorStop(0,"yellow");
            // grd.addColorStop(1,"white");
            // ctx.font = "2px Arial";
            // ctx.strokeText(lv,0,8);
            // ctx.fillStyle = grd;
            // ctx.fillText(lv,0,8);
            
            //dragon icon
            ctx.drawImage(icon, 96, 96, 96, 96, 4, 12, 20, 20);
            
            //dragon HP
            ctx.fillStyle="#842B00";
            ctx.strokeRect(24,7,102,12);
            ctx.fillStyle="#EA0000";
            ctx.fillRect(25,8, 100, 10);
            ctx.fillStyle="#FFD306";
            ctx.fillRect(25,8, hpLength, 10);
            
            //dragon EXP
            ctx.fillStyle="#842B00";
            ctx.strokeRect(25,20,100,4);
            ctx.fillStyle="#000079";
            ctx.fillRect(26,21, 98, 2);
            ctx.fillStyle="#28FF28";
            ctx.fillRect(26,21, expBar, 2);
            
            //dragon ChargeBar
            ctx.fillStyle="#842B00";
            ctx.strokeRect(25,25,30,6);
            ctx.fillStyle="#000079";
            ctx.fillRect(26,26, 28, 4);
            ctx.fillStyle="#BE77FF";
            ctx.fillRect(26,26, chargeBar, 4);
            ctx.restore();
        }
      
        function animate(){
            if(isGaming){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            
                moveDragon();
                drawDragon();
                if(dragon.exp >= dragon.lupExp){
                    dragon.level++;
                    dragon.lupExp += Math.pow(dragon.level, 1.5) * 100; 
                    dragon.maxHp += dragon.level * 20;
                    recoverHp();
                    dragon.exp = 0;
                }
                     
                for(var i=0; i<balls.length; i++){
                    moveBall(balls[i]);  
                    drawBall(balls[i]);
                }
                
                if(Math.random() * 500 < 3) enermys.push(new enermy());
                if(Math.random() * 500 < 3) enermys.push(new enermy2());
                if(enermys.length == 0) Math.random() > 0.5 ? enermys.push(new enermy()) : enermys.push(new enermy2()) ;
                for(var i = 0; i < enermys.length; i++){
                    enermys[i].moveEnermy();
                    if(enermys[i] != null){
                        enermys[i].drawEnermy();
                        if(Math.random()*200 < 1)enermys[i].shot(); 
                    }
                }
           
                for(var i=0; i<enermyballs.length; i++){
                    moveEnermyBall(enermyballs[i]);  
                    drawEnermyBall(enermyballs[i]);
                }
                drawState();
                
                if(chargeNum > 50){
                    isCharging = true;
                    chargeSound.play();
                }
                
                //測試用
                var s = "X :" + dragon.X + ", Y :"+dragon.Y + ", balls :"+ balls.length +
                ", charge :" + isCharging + ", level : " + dragon.level + 
                ", HP :"+ dragon.hp + ", nextlv :" + Math.floor(dragon.lupExp - dragon.exp)+", enermys"+
                enermys.length + ", dImg.src :"+ dImg.src; 
                $("#report").text(s);    
            }
        }
        
        function reduceHp(x){
            var hpMinus = x;
            //alert(hpMinus);
            var timer = setInterval(function(){
                dragon.hp--;
                hpMinus--;
                //alert(hpMinus)
                if(hpMinus <= 0){
                    clearInterval(timer);
                }
            },25);
        }
        
        function recoverHp(){
            var timer = setInterval(function(){
                dragon.hp++;
                if(dragon.hp >= dragon.maxHp){
                    dragon.hp = dragon.maxHp;
                    clearInterval(timer);
                }
            },5);
        }
        
        function startGame(){
            if(isGaming){
                gameLoop = setInterval(animate, 20);
                $(document).keydown(function(evt) {
                   if(evt.keyCode == 32){
                        charge();   
                   }
                   if(evt.keyCode == 13){
                        enermys.push(new enermy());   
                   }
                   if(evt.keyCode == 37){
                        dragon.Move = 'LEFT';   
                   }
                   if(evt.keyCode == 38){
                        dragon.Move = 'UP';   
                   }
                   if(evt.keyCode == 39){
                        dragon.Move = 'RIGHT';   
                   }
                   if(evt.keyCode == 40){
                        dragon.Move = 'DOWN';   
                   }
                   
                });         
                
                $(document).keyup(function(evt) {
                    
                    if(evt.keyCode == 32){
                        dragon.shot();   
                    }
                    if(evt.keyCode == 37){
                        dragon.Move = 'l-NONE';   
                    }
                    if(evt.keyCode == 38){
                        dragon.Move = 'u-NONE';   
                    }
                    if(evt.keyCode == 39){
                        dragon.Move = 'r-NONE';  
                    }
                    if(evt.keyCode == 40){
                        dragon.Move = 'd-NONE';   
                    }
                });
            }
        }
        startGame();
    });

</script>
</head>
</html>