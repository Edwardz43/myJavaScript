<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<title>Game</title>    
<head>
<script type="text/javascript" src="jquery.js"></script>
<style>
#myCanvas{
    position: absolute;
    top: 0;
    left: 0;
    width : 1440px; 
    height : 600px;
}
#myBG {
	position: relative;
	width: 1440px;
	height: 600px;
	margin: 0;
	overflow: hidden;
	outline: 1px solid gray;
}

#bGImg {
	position: relative;
	width: 3502px;
	height: 600px;
	background : url('images/BG003.jpg');
	background-repeat: repeat-x;
    animation: rollImage linear 50s infinite;
    z-index:-1;
}


@keyframes rollImage {
	from { right: 0px; }
	to { right: 2062px; }
}

</style>
<body>
<img id="fireBall" src="images/fire01.png" style="display: none"></img>
<div id="myBG">
    <div id="bGImg"></div>
</div>
<div><canvas class="myGame" id="myCanvas"></canvas></div>
<br>
<div id="report"></div>

</body>
<script>

    $(document).ready(function(){
        var canvas = $('#myCanvas')[0];
        var ctx = canvas.getContext('2d');
        var gameLoop;
        var balls = [];
        var dImg = new Image();
        var eImg = new Image();
        var enermys = [];
        
        var dragon = {
            level : 8,
            hP : 200,
            X : 100,
            Y : 100,
            Dx :0,
            Dy :0,
            speed : 2,
            width : 30,
            height : 30,
            Move : "none",
            shot : function (){
                balls.push(new Ball(dragon.X + 25, dragon.Y + 15 -dragon.level, 3));
                var fireSound = new Audio('BGM/wing1.mp3');
                fireSound.volume = 0.3;
                fireSound.play();
            }
        }
        
        function moveDragon(){
            switch(dragon.Move) {
                case 'LEFT':
                    dragon.Dx = -dragon.speed;
                    break;
                case 'UP':
                    dragon.Dy = -dragon.speed;
                    break;    
                case 'RIGHT':
                    dragon.Dx = dragon.speed;
                    break;
                case 'DOWN':
                    dragon.Dy = dragon.speed;
                    break;    
                case 'l-NONE':
                case 'r-NONE':
                    dragon.Dx = 0;
                    break;
                case 'u-NONE':
                case 'd-NONE':
                    dragon.Dy = 0;
                    break;
            }
            //bug
            if (dragon.X + dragon.Dx < 0 || dragon.X + dragon.Dx + dragon.width >= canvas.width){
                dragon.Dx = 0; 
            }
            if (dragon.Y + dragon.Dy < 0 || dragon.Y + dragon.Dy +dragon.height > canvas.height){
                dragon.Dy = 0; 
            }
            dragon.X = dragon.X + dragon.Dx;
            dragon.Y = dragon.Y + dragon.Dy;
        }
        
        var count = 1;
        function drawDragon(){
            if (count >= 24) count = 1;
            ctx.save();
            dImg.src = 'images/dR0' + Math.floor(count / 6 + 1) + '.png',
            ctx.drawImage(dImg, dragon.X, dragon.Y, dragon.width , dragon.height );
            ctx.restore();   
            count++;
        }
        
        
        var enermy = function () {
            this.level = 1;
            this.hp = 20;
            this.X = 200;
            this.Y = 80;
            this.Dx = 0;
            this.Dy = 1;
            this.speed = 1;
            this.width = 30;
            this.height = 30;
            
            this.shot = function (){
                balls.push(new Ball(this.X - 25, this.Y + 15 -this.level, -3));
                var fireSound = new Audio('BGM/wing1.mp3');
                fireSound.volume = 0.3;
                fireSound.play();
            }
            
            this.moveEnermy = function (){
                
                if(this.Y + this.height >= canvas.height ||
                    this.Y - this.height <= 0 ) {this.Dy *= -1;}
                this.X += this.Dx;
                this.Y += this.Dy;    
            }
            var c = 1
            this.drawEnermy = function() {
                if(this.hp >= 0){
                    if(c >= 24) c = 1;
                    eImg.src = 'images/dR0'+ Math.floor(c / 6 + 1) +'_burned.png';
                    //ctx.clearRect(0,0,canvas.width,canvas.height);
                    ctx.drawImage(eImg, this.X, this.Y, this.width, this.height);
                    // ctx.rotate(Math.PI);
                    c++;
                }else{
                    enermys.splice(enermys.indexOf(this),1);
                }
            }
            
        }
        
        
        
        function Ball(X, Y, deltaX){
            this.X = X;
            this.Y = Y;
            this.width = 18 + dragon.level;   
            this.height = 9 + dragon.level;
            this.deltaX = deltaX;
            this.power = dragon.level * 2;
            this.hit = false;
        }
            
        function moveBall(ballI){
            var ball = ballI;
            if(ball != null){
                if (ball.X + ball.deltaX + ball.Radius > canvas.width){
                    balls.splice(balls.indexOf(ball), 1);
                }
                
                //攻擊命中
                for(var i=0; i < enermys.length; i++){
                    if ((ball.X + ball.deltaX - 18 >= enermys[i].X - enermys[i].width && 
                        ball.Y  >= enermys[i].Y - enermys[i].height * 0.5 && 
                        ball.Y  <= enermys[i].Y + enermys[i].height * 0.5)){
                        var hitSound = new Audio('BGM/fireworks2.mp3');
                        hitSound.volume = 1;
                        hitSound.play();
                        ball.hit = true;
                        enermys[i].hp -= ball.power;
                    }
                }
                // {//||(ball.Y + ball.DeltaY + ball.Radius < paddle.Y)
                //     // and it is positioned between the two ends of the paddle (is on top)
                //     if (ball.X + ball.deltaX >= paddle.X && 
                //         ball.X + ball.deltaX <= paddle.X + paddle.Width){
                //         ball.DeltaY *= -1;
                //         bouncingSound.play();
                //     }
                // }
                // Move the ball
                ball.X += ball.deltaX;
            }
        }
        
        function drawBall(ballI) {
            //如果球被刪除了  就=null 那就不必畫了
            if(ballI != null){
                var ball = ballI;
                if(ball.hit != true){
                	ctx.save();
                	var fire = document.getElementById('fireBall');
                    ctx.drawImage(fire, ball.X, ball.Y, ball.width, ball.height);
                    ctx.restore();
                }else{
                    
                    balls.splice(balls.indexOf(ball), 1);
                }
            }
        }
    
        function animate(){
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            moveDragon();
            drawDragon();
            
            if(enermys.length <= 0) enermys.push(new enermy());
            for(var i = 0; i < enermys.length; i++){
                enermys[i].moveEnermy();
                enermys[i].drawEnermy();
            }
            for(var i=0; i<balls.length; i++){
                //ctx.clearRect(balls[i].X, balls[i].Y, 20, 10)
                moveBall(balls[i]);  
                drawBall(balls[i]);
            }
            
            var s = "X :" + dragon.X + ", Y :"+dragon.Y + 
            ", c.width :" + canvas.width+ ", c.height :" + canvas.height +
            "dImg : " + dImg.src;
            $("#report").text(s);
        }
        
        function startGame(){

            gameLoop = setInterval(animate, 20);
            
            $(document).keydown(function(evt) {
                switch (evt.keyCode) {
                    case 32:
                        dragon.shot();
                        break;
                    case 37:
                        dragon.Move = 'LEFT';
                        break;
                    case 38:
                        dragon.Move = 'UP';
                        break;
                    case 39:
                        dragon.Move = 'RIGHT';
                        break;
                    case 40:
                        dragon.Move = 'DOWN';
                        break;
                    
                    default:
                        dragon.Move = 'NONE';
                }
            });         
            
            $(document).keyup(function(evt) {
                switch (evt.keyCode) {
                    case 37:
                        dragon.Move = 'l-NONE';
                        break;
                    case 38:
                        dragon.Move = 'u-NONE';
                        break;
                    case 39:
                        dragon.Move = 'r-NONE';
                        break;
                    case 40:
                        dragon.Move = 'd-NONE';
                        break;
                    default:
                        dragon.Move = 'NONE';
                }
            }); 
        }
        startGame();

    });
</script>
</head>
</html>